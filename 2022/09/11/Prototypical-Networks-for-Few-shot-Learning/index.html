<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Prototypical Networks for Few-shot Learning 1. Introduction of Prototypical Networks  Prototypical Network is a Deep-Learning algorithm for Few-shot Learning.">
<meta property="og:type" content="article">
<meta property="og:title" content="Prototypical Networks for Few-shot Learning">
<meta property="og:url" content="http://example.com/2022/09/11/Prototypical-Networks-for-Few-shot-Learning/index.html">
<meta property="og:site_name" content="jimore">
<meta property="og:description" content="Prototypical Networks for Few-shot Learning 1. Introduction of Prototypical Networks  Prototypical Network is a Deep-Learning algorithm for Few-shot Learning.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200607084457804.PNG#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200607084029679.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hlaTY1Mzc3OTkxOQ==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200607084059981.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hlaTY1Mzc3OTkxOQ==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2020060708482682.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hlaTY1Mzc3OTkxOQ==,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="https://melissa838.github.io/images/7.png">
<meta property="article:published_time" content="2022-09-11T07:56:30.000Z">
<meta property="article:modified_time" content="2022-09-24T03:38:44.222Z">
<meta property="article:author" content="jimore">
<meta property="article:tag" content="深度学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20200607084457804.PNG#pic_center">

<link rel="canonical" href="http://example.com/2022/09/11/Prototypical-Networks-for-Few-shot-Learning/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Prototypical Networks for Few-shot Learning | jimore</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="jimore" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">jimore</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">4</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">3</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">39</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/11/Prototypical-Networks-for-Few-shot-Learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hh.jpg">
      <meta itemprop="name" content="jimore">
      <meta itemprop="description" content="Don't let the dream just be the dream">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jimore">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Prototypical Networks for Few-shot Learning
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-11 15:56:30" itemprop="dateCreated datePublished" datetime="2022-09-11T15:56:30+08:00">2022-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-24 11:38:44" itemprop="dateModified" datetime="2022-09-24T11:38:44+08:00">2022-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">深度学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1>Prototypical Networks for Few-shot Learning</h1>
<h2 id="1-Introduction-of-Prototypical-Networks">1. Introduction of Prototypical Networks</h2>
<blockquote>
<p>Prototypical Network is a Deep-Learning algorithm for Few-shot Learning.</p>
</blockquote>
<span id="more"></span>
<h2 id="2-The-working-function-of-Prototypical-Networks">2.The working function of Prototypical Networks</h2>
<h3 id="2-1Example">2.1Example</h3>
<p>Now, we possess a support set including some images of Lion, Elephant, and Dog. In the other words, in this categorizing assignment, we have three categories: {Lion, Elephant, Dog}. Now, we should create three prototypes for the three categories. The building process of Prototypical Networks is as follows.</p>
<p>(1) To begin with, in every sample, we use the coding method to learn every corresponding code expression.</p>
<img src="https://img-blog.csdnimg.cn/20200607084457804.PNG#pic_center">
<p>For example, we can use a Convolutional operation to extract code information from every image.</p>
<img src="https://img-blog.csdnimg.cn/20200607084029679.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hlaTY1Mzc3OTkxOQ==,size_16,color_FFFFFF,t_70#pic_center">
<p>(2)secondly, after learning the code information of every sample, we sum the code information of every sample, get the average and turn them into the corresponding Prototypical information.</p>
<img src="https://img-blog.csdnimg.cn/20200607084059981.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hlaTY1Mzc3OTkxOQ==,size_16,color_FFFFFF,t_70#pic_center">
<p>(3) thirdly, what we need to do is calculate every distance between the new image and the prototype of every category to check out what category the new sample belongs to. we can use the <strong>Euclidean distance</strong> and the <strong>Cos Similarity</strong> to calculate the distance.</p>
<img src="https://img-blog.csdnimg.cn/2020060708482682.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hlaTY1Mzc3OTkxOQ==,size_16,color_FFFFFF,t_70#pic_center">
<p>(4) In the final step, after calculating every distance, we use <strong>Softmax</strong> to turn the distances into the corresponding odds.</p>
<h2 id="3-The-description-of-the-algorithm">3.The description of the algorithm</h2>
<img src="https://melissa838.github.io/images/7.png">
<h2 id="4-Implementation-of-Prototypical-Networks">4. Implementation of Prototypical Networks</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createData</span>():</span><br><span class="line"><span class="comment">#### training datasets</span></span><br><span class="line">    text_list_pos = [<span class="string">"电影内容很好"</span>,<span class="string">"电影题材很好"</span>,<span class="string">"演员演技很好"</span>,<span class="string">"故事很感人"</span>,<span class="string">"电影特效很好"</span>]</span><br><span class="line">    text_list_neg = [<span class="string">"电影内容垃圾"</span>,<span class="string">"电影是真的垃圾"</span>,<span class="string">"表演太僵硬了"</span>,<span class="string">"故事又臭又长"</span>,<span class="string">"电影太让人失望了"</span>]</span><br><span class="line"><span class="comment">#### testing datasets</span></span><br><span class="line">    test_pos = [<span class="string">"电影"</span>,<span class="string">"很"</span>,<span class="string">"好"</span>]</span><br><span class="line">    test_neg = [<span class="string">"电影"</span>,<span class="string">"垃圾"</span>]</span><br><span class="line">    words_pos = [[item <span class="keyword">for</span> item <span class="keyword">in</span> jieba.cut(text)] <span class="keyword">for</span> text <span class="keyword">in</span> text_list_pos]</span><br><span class="line">    words_neg = [[item <span class="keyword">for</span> item <span class="keyword">in</span> jieba.cut(text)] <span class="keyword">for</span> text <span class="keyword">in</span> text_list_neg]</span><br><span class="line">    words_all = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> words_pos:</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> item:</span><br><span class="line">            words_all.append(key)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> words_neg:</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> item:</span><br><span class="line">            words_all.append(key)</span><br><span class="line">    vocab = <span class="built_in">list</span>(<span class="built_in">set</span>(words_all))</span><br><span class="line">    word2idx = {w:c <span class="keyword">for</span> c,w <span class="keyword">in</span> <span class="built_in">enumerate</span>(vocab)}</span><br><span class="line">    idx_words_pos = [[word2idx[item] <span class="keyword">for</span> item <span class="keyword">in</span> text] <span class="keyword">for</span> text <span class="keyword">in</span> words_pos]</span><br><span class="line">    idx_words_neg = [[word2idx[item] <span class="keyword">for</span> item <span class="keyword">in</span> text] <span class="keyword">for</span> text <span class="keyword">in</span> words_neg]</span><br><span class="line">    idx_test_pos = [word2idx[item] <span class="keyword">for</span> item <span class="keyword">in</span> test_pos]</span><br><span class="line">    idx_test_neg = [word2idx[item] <span class="keyword">for</span> item <span class="keyword">in</span> test_neg]</span><br><span class="line">    <span class="keyword">return</span> vocab,word2idx,idx_words_pos,idx_words_neg,idx_test_pos,idx_test_neg</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createOneHot</span>(<span class="params">vocab,idx_words_pos,idx_words_neg,idx_test_pos,idx_test_neg</span>):</span><br><span class="line">    input_dim = <span class="built_in">len</span>(vocab)</span><br><span class="line">    features_pos = torch.zeros(size=[<span class="built_in">len</span>(idx_words_pos),input_dim])</span><br><span class="line">    features_neg = torch.zeros(size=[<span class="built_in">len</span>(idx_words_neg), input_dim])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(idx_words_pos)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> idx_words_pos[i]:</span><br><span class="line">            features_pos[i,j] = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(idx_words_neg)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> idx_words_neg[i]:</span><br><span class="line">            features_neg[i,j] = <span class="number">1.0</span></span><br><span class="line">    features = torch.cat([features_pos,features_neg],dim=<span class="number">0</span>)</span><br><span class="line">    labels = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    labels = torch.LongTensor(labels)</span><br><span class="line">    test_x_pos = torch.zeros(size=[<span class="number">1</span>,input_dim])</span><br><span class="line">    test_x_neg = torch.zeros(size=[<span class="number">1</span>,input_dim])</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> idx_test_pos:</span><br><span class="line">        test_x_pos[<span class="number">0</span>,item] = <span class="number">1.0</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> idx_test_neg:</span><br><span class="line">        test_x_neg[<span class="number">0</span>,item] = <span class="number">1.0</span></span><br><span class="line">    test_x = torch.cat([test_x_pos,test_x_neg],dim=<span class="number">0</span>)</span><br><span class="line">    test_labels = torch.LongTensor([<span class="number">1</span>,<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">return</span> features,labels,test_x,test_labels</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">randomGenerate</span>(<span class="params">features</span>):</span><br><span class="line">    N = features.shape[<span class="number">0</span>]</span><br><span class="line">    half_n = N // <span class="number">2</span></span><br><span class="line">    support_input = torch.zeros(size=[<span class="number">6</span>, features.shape[<span class="number">1</span>]])</span><br><span class="line">    query_input = torch.zeros(size=[<span class="number">4</span>,features.shape[<span class="number">1</span>]])</span><br><span class="line">    postive_list = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">0</span>,half_n))</span><br><span class="line">    negtive_list = <span class="built_in">list</span>(<span class="built_in">range</span>(half_n,N))</span><br><span class="line">    support_list_pos = random.sample(postive_list,<span class="number">3</span>)</span><br><span class="line">    support_list_neg = random.sample(negtive_list,<span class="number">3</span>)</span><br><span class="line">    query_list_pos = [item <span class="keyword">for</span> item <span class="keyword">in</span> postive_list <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> support_list_pos]</span><br><span class="line">    query_list_neg = [item <span class="keyword">for</span> item <span class="keyword">in</span> negtive_list <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> support_list_neg]</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> support_list_pos:</span><br><span class="line">        support_input[index,:] = features[item,:]</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> support_list_neg:</span><br><span class="line">        support_input[index,:] = features[item,:]</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> query_list_pos:</span><br><span class="line">        query_input[index,:] = features[item,:]</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> query_list_neg:</span><br><span class="line">        query_input[index,:] = features[item,:]</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    query_label = torch.LongTensor([<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">return</span> support_input,query_input,query_label</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">fewModel</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,input_dim,hidden_dim,num_class</span>):</span><br><span class="line">        <span class="built_in">super</span>(fewModel,self).__init__()</span><br><span class="line">        self.input_dim = input_dim</span><br><span class="line">        self.hidden_dim = hidden_dim</span><br><span class="line">        self.num_class = num_class</span><br><span class="line">        <span class="comment"># 线性层进行编码</span></span><br><span class="line">        self.linear = nn.Linear(input_dim,hidden_dim)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">embedding</span>(<span class="params">self,features</span>):</span><br><span class="line">        result = self.linear(features)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self,support_input,query_input</span>):</span><br><span class="line">        <span class="comment"># get the feature vector of the support_input</span></span><br><span class="line">        support_embedding = self.embedding(support_input)</span><br><span class="line">        <span class="comment"># get the feature vector of the query_input</span></span><br><span class="line">        query_embedding = self.embedding(query_input)</span><br><span class="line">        support_size = support_embedding.shape[<span class="number">0</span>]</span><br><span class="line">        every_class_num  = support_size // self.num_class</span><br><span class="line">        class_meta_dict = {}</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,self.num_class):</span><br><span class="line">            class_meta_dict[i] = torch.<span class="built_in">sum</span>(support_embedding[i*every_class_num:(i+<span class="number">1</span>)*every_class_num,:],dim=<span class="number">0</span>) / every_class_num</span><br><span class="line">        <span class="comment"># class_meta_dict[i] is the prototype of the class_i</span></span><br><span class="line">        class_meta_information = torch.zeros(size=[<span class="built_in">len</span>(class_meta_dict),support_embedding.shape[<span class="number">1</span>]])</span><br><span class="line">        <span class="comment"># class_meta_information congregate all the prototypes of the classes and form a two lines vector.</span></span><br><span class="line">        <span class="keyword">for</span> key,item <span class="keyword">in</span> class_meta_dict.items():</span><br><span class="line">            class_meta_information[key,:] = class_meta_dict[key]</span><br><span class="line">        N_query = query_embedding.shape[<span class="number">0</span>]</span><br><span class="line">        result = torch.zeros(size=[N_query,self.num_class])</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,N_query):</span><br><span class="line">            temp_value = query_embedding[i].repeat(self.num_class,<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># temp_value can be thought as the feature of the query_input.</span></span><br><span class="line">            cosine_value = torch.cosine_similarity(class_meta_information,temp_value,dim=<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># cosine_value represent the distances between the query_input and the prototypes of all the categories, and represent the similarity scores between the query_input and all the categories.</span></span><br><span class="line">            result[i] = cosine_value</span><br><span class="line">        <span class="comment"># result=F.softmax(result,dim=1) can get the predicted categories the query_input and express them in the form of one-hot vectors.</span></span><br><span class="line">        result = F.log_softmax(result,dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">hidden_dim = <span class="number">4</span></span><br><span class="line">n_class = <span class="number">2</span></span><br><span class="line">lr = <span class="number">0.01</span></span><br><span class="line">epochs = <span class="number">1000</span></span><br><span class="line">vocab,word2idx,idx_words_pos,idx_words_neg,idx_test_pos,idx_test_neg = createData()</span><br><span class="line">features,labels,test_x,test_labels = createOneHot(vocab,idx_words_pos,idx_words_neg,idx_test_pos,idx_test_neg)</span><br><span class="line"></span><br><span class="line">model = fewModel(features.shape[<span class="number">1</span>],hidden_dim,n_class)</span><br><span class="line">optimer = optim.Adam(model.parameters(),lr=lr,weight_decay=<span class="number">5e-4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">epoch,support_input,query_input,query_label</span>):</span><br><span class="line">    optimer.zero_grad()</span><br><span class="line">    output = model(support_input,query_input)</span><br><span class="line">    loss = F.nll_loss(output,query_label)</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimer.step()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Epoch: {:04d}"</span>.<span class="built_in">format</span>(epoch),<span class="string">"loss:{:.4f}"</span>.<span class="built_in">format</span>(loss))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        support_input, query_input, query_label = randomGenerate(features)</span><br><span class="line">        train(i,support_input,query_input,query_label)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="5-Prototypical-Networks-implementation-in-Omniglot">5.Prototypical Networks implementation in <strong>Omniglot</strong></h2>
<p>1.define the CNN to extract the features of every images</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">eucli_tensor</span>(<span class="params">x,y</span>):	<span class="comment">#计算两个tensor的欧氏距离，用于loss的计算</span></span><br><span class="line">	<span class="keyword">return</span> -<span class="number">1</span>*torch.sqrt(torch.<span class="built_in">sum</span>((x-y)*(x-y))).view(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CNNnet</span>(torch.nn.Module):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,input_shape,outDim</span>):	<span class="comment">#input_shape是一个有3个元素组成的元组，input_shape[0]代表输入的深度，input_shape[1]宽，input_shape[2]长，outDim为嵌入空间的维度</span></span><br><span class="line">		<span class="built_in">super</span>(CNNnet,self).__init__()</span><br><span class="line">		self.conv1 = torch.nn.Sequential(</span><br><span class="line">			torch.nn.Conv2d(in_channels=input_shape[<span class="number">0</span>],</span><br><span class="line">							out_channels=<span class="number">16</span>,</span><br><span class="line">							kernel_size=<span class="number">3</span>,</span><br><span class="line">							stride=<span class="number">1</span>,</span><br><span class="line">							padding=<span class="number">1</span>),</span><br><span class="line">			torch.nn.BatchNorm2d(<span class="number">16</span>),</span><br><span class="line">			torch.nn.MaxPool2d(<span class="number">2</span>),</span><br><span class="line">			torch.nn.ReLU()</span><br><span class="line">		)</span><br><span class="line">		self.conv2 = torch.nn.Sequential(</span><br><span class="line">			torch.nn.Conv2d(<span class="number">16</span>,<span class="number">32</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">			torch.nn.BatchNorm2d(<span class="number">32</span>),</span><br><span class="line">			nn.MaxPool2d(<span class="number">2</span>),</span><br><span class="line">			torch.nn.ReLU()</span><br><span class="line">		)</span><br><span class="line">		self.conv3 = torch.nn.Sequential(</span><br><span class="line">			torch.nn.Conv2d(<span class="number">32</span>,<span class="number">64</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">			torch.nn.BatchNorm2d(<span class="number">64</span>),</span><br><span class="line">			nn.MaxPool2d(<span class="number">2</span>),</span><br><span class="line">			torch.nn.ReLU()</span><br><span class="line">		)</span><br><span class="line">		self.conv4 = torch.nn.Sequential(</span><br><span class="line">			torch.nn.Conv2d(<span class="number">64</span>,<span class="number">64</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">			torch.nn.BatchNorm2d(<span class="number">64</span>),</span><br><span class="line">			<span class="comment">#nn.MaxPool2d(2)</span></span><br><span class="line">			torch.nn.ReLU()</span><br><span class="line">		)</span><br><span class="line">		self.conv5 = torch.nn.Sequential(</span><br><span class="line">			torch.nn.Conv2d(<span class="number">64</span>,<span class="number">64</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">			torch.nn.BatchNorm2d(<span class="number">64</span>),</span><br><span class="line">			<span class="comment">#nn.MaxPool2d(2)</span></span><br><span class="line">			torch.nn.ReLU()</span><br><span class="line">		)</span><br><span class="line">		self.mlp1 = torch.nn.Linear(<span class="number">10816</span>,<span class="number">125</span>)</span><br><span class="line">		self.mlp2 = torch.nn.Linear(<span class="number">125</span>,outDim)</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">		x = self.conv1(x)</span><br><span class="line">		x = self.conv2(x)</span><br><span class="line">		x = self.conv3(x)</span><br><span class="line">		x = self.conv4(x)</span><br><span class="line">		x = self.conv5(x)</span><br><span class="line">		x = self.mlp1(x.view(x.size(<span class="number">0</span>),-<span class="number">1</span>))</span><br><span class="line">		x = self.mlp2(x)</span><br><span class="line">		<span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<p>2.define the <strong>Prototypical Network</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Protonets</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,input_shape,outDim,Ns,Nq,Nc,log_data,step,trainval=<span class="literal">False</span></span>):</span><br><span class="line">		<span class="comment">#Ns:支持集数量,Nq：查询集数量,Nc：每次迭代所选类数,log_data：模型和类对应的中心所要储存的位置,step:若trainval==True则读取已训练的第step步的模型和中心,trainval：是否从新开始训练模型</span></span><br><span class="line">		self.input_shape = input_shape</span><br><span class="line">		self.outDim = outDim</span><br><span class="line">		self.batchSize = <span class="number">1</span></span><br><span class="line">		self.Ns = Ns</span><br><span class="line">		self.Nq = Nq</span><br><span class="line">		self.Nc = Nc</span><br><span class="line">		<span class="keyword">if</span> trainval == <span class="literal">False</span>:</span><br><span class="line">			<span class="comment">#若训练一个新的模型，初始化CNN和中心点</span></span><br><span class="line">			self.center = {}</span><br><span class="line">			self.model = CNNnet(input_shape,outDim)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="comment">#否则加载CNN模型和中心点</span></span><br><span class="line">			self.center = {}</span><br><span class="line">			self.model = torch.load(log_data+<span class="string">'model_net_'</span>+<span class="built_in">str</span>(step)+<span class="string">'.pkl'</span>)</span><br><span class="line">			self.load_center(log_data+<span class="string">'model_center_'</span>+<span class="built_in">str</span>(step)+<span class="string">'.csv'</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">compute_center</span>(<span class="params">self,data_set</span>):	<span class="comment">#data_set是一个numpy对象，是某一个支持集，计算支持集对应的中心的点</span></span><br><span class="line">		center = <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.Ns):</span><br><span class="line">			data = np.reshape(data_set[i], [<span class="number">1</span>, self.input_shape[<span class="number">0</span>], self.input_shape[<span class="number">1</span>], self.input_shape[<span class="number">2</span>]])</span><br><span class="line">			data = Variable(torch.from_numpy(data))</span><br><span class="line">			data = self.model(data)[<span class="number">0</span>]	<span class="comment">#将查询点嵌入另一个空间</span></span><br><span class="line">			<span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">				center = data</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				center += data</span><br><span class="line">		center /= self.Ns</span><br><span class="line">		<span class="keyword">return</span> center</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">self,labels_data,class_number</span>):	<span class="comment">#网络的训练</span></span><br><span class="line">		<span class="comment">#Select class indices for episode</span></span><br><span class="line">		class_index = <span class="built_in">list</span>(<span class="built_in">range</span>(class_number))</span><br><span class="line">		random.shuffle(class_index)</span><br><span class="line">		choss_class_index = class_index[:self.Nc]</span><br><span class="line">		sample = {<span class="string">'xc'</span>:[],<span class="string">'xq'</span>:[]}</span><br><span class="line">		<span class="keyword">for</span> label <span class="keyword">in</span> choss_class_index:</span><br><span class="line">			D_set = labels_data[label]</span><br><span class="line">			<span class="comment">#从D_set随机取支持集和查询集</span></span><br><span class="line">			support_set,query_set = self.randomSample(D_set)</span><br><span class="line">			<span class="comment">#计算中心点</span></span><br><span class="line">			self.center[label] = self.compute_center(support_set)</span><br><span class="line">			<span class="comment">#将支持集和查询集存储在list中</span></span><br><span class="line">			sample[<span class="string">'xc'</span>].append(self.center[label])	<span class="comment">#list</span></span><br><span class="line">			sample[<span class="string">'xq'</span>].append(query_set)</span><br><span class="line">		<span class="comment">#优化器</span></span><br><span class="line">		optimizer = torch.optim.Adam(self.model.parameters(),lr=<span class="number">0.001</span>)</span><br><span class="line">		optimizer.zero_grad()</span><br><span class="line">		protonets_loss = self.loss(sample)</span><br><span class="line">		protonets_loss.backward()</span><br><span class="line">		optimizer.step()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">loss</span>(<span class="params">self,sample</span>):	<span class="comment">#自定义loss</span></span><br><span class="line">		loss_1 = autograd.Variable(torch.FloatTensor([<span class="number">0</span>]))</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.Nc):</span><br><span class="line">			query_dataSet = sample[<span class="string">'xq'</span>][i]</span><br><span class="line">			<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(self.Nq):</span><br><span class="line">				data = np.reshape(query_dataSet[n], [<span class="number">1</span>, self.input_shape[<span class="number">0</span>], self.input_shape[<span class="number">1</span>], self.input_shape[<span class="number">2</span>]])</span><br><span class="line">				data = Variable(torch.from_numpy(data))</span><br><span class="line">				data = self.model(data)[<span class="number">0</span>]	<span class="comment">#将查询点嵌入另一个空间</span></span><br><span class="line">				<span class="comment">#查询点与每个中心点逐个计算欧氏距离</span></span><br><span class="line">				predict = <span class="number">0</span></span><br><span class="line">				<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(self.Nc):</span><br><span class="line">					center_j = sample[<span class="string">'xc'</span>][j]</span><br><span class="line">					<span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">						predict = eucli_tensor(data,center_j)</span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						predict = torch.cat((predict, eucli_tensor(data,center_j)), <span class="number">0</span>)</span><br><span class="line">				<span class="comment">#为loss叠加</span></span><br><span class="line">				loss_1 += -<span class="number">1</span>*F.log_softmax(predict)[i]</span><br><span class="line">		loss_1 /= self.Nq*self.Nc</span><br><span class="line">		<span class="keyword">return</span> loss_1</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">randomSample</span>(<span class="params">self,D_set</span>): <span class="comment">#从D_set随机取支持集和查询集</span></span><br><span class="line">		index_list = <span class="built_in">list</span>(<span class="built_in">range</span>(D_set.shape[<span class="number">0</span>]))</span><br><span class="line">		random.shuffle(index_list)</span><br><span class="line">		support_data_index = index_list[:self.Ns]</span><br><span class="line">		query_data_index = index_list[self.Ns:self.Ns + self.Nq]</span><br><span class="line">		support_set = []</span><br><span class="line">		query_set = []</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> support_data_index:</span><br><span class="line">			support_set.append(D_set[i])</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> query_data_index:</span><br><span class="line">			query_set.append(D_set[i])</span><br><span class="line">		<span class="keyword">return</span> support_set,query_set</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">evaluation_model</span>(<span class="params">self,labels_testData,labels_trainData</span>):</span><br><span class="line">		train_accury = []</span><br><span class="line">		<span class="keyword">for</span> y <span class="keyword">in</span> self.center.keys():</span><br><span class="line">			<span class="keyword">for</span> data <span class="keyword">in</span> labels_trainData[y]:</span><br><span class="line">				data = np.reshape(data, [<span class="number">1</span>, self.input_shape[<span class="number">0</span>], self.input_shape[<span class="number">1</span>], self.input_shape[<span class="number">2</span>]])</span><br><span class="line">				data = Variable(torch.from_numpy(data))</span><br><span class="line">				data = self.model(data)[<span class="number">0</span>]	<span class="comment">#将test.data嵌入另一个空间</span></span><br><span class="line">				predict = <span class="number">0</span></span><br><span class="line">				j2label_c = {}</span><br><span class="line">				j = <span class="number">0</span>	<span class="comment">#第j个中心</span></span><br><span class="line">				<span class="keyword">for</span> label_c <span class="keyword">in</span> self.center.keys():	<span class="comment">#计算data到每个中心点得距离</span></span><br><span class="line">					center_j = self.center[label_c]</span><br><span class="line">					j2label_c[j] = label_c</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">						predict = eucli_tensor(data,center_j)</span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						predict = torch.cat((predict, eucli_tensor(data,center_j)), <span class="number">0</span>)</span><br><span class="line">					j += <span class="number">1</span></span><br><span class="line">				<span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">				y_pre_j = <span class="built_in">int</span>(torch.argmax(F.log_softmax(predict)))	<span class="comment">#离第j个中心最近</span></span><br><span class="line">				<span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">				y_pre = j2label_c[y_pre_j]	<span class="comment">#第j个中心对应得标签是y_pre</span></span><br><span class="line">				train_accury.append(<span class="number">1</span> <span class="keyword">if</span> y_pre == y <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">		test_accury = []</span><br><span class="line">		<span class="keyword">for</span> y <span class="keyword">in</span> self.center.keys():</span><br><span class="line">			<span class="keyword">for</span> data <span class="keyword">in</span> labels_testData[y]:</span><br><span class="line">				data = np.reshape(data, [<span class="number">1</span>, self.input_shape[<span class="number">0</span>], self.input_shape[<span class="number">1</span>], self.input_shape[<span class="number">2</span>]])</span><br><span class="line">				data = Variable(torch.from_numpy(data))</span><br><span class="line">				data = self.model(data)[<span class="number">0</span>]	<span class="comment">#将test.data嵌入另一个空间</span></span><br><span class="line">				predict = <span class="number">0</span></span><br><span class="line">				j2label_c = {}</span><br><span class="line">				j = <span class="number">0</span>	<span class="comment">#第j个中心</span></span><br><span class="line">				<span class="keyword">for</span> label_c <span class="keyword">in</span> self.center.keys():	<span class="comment">#计算data到每个中心点得距离</span></span><br><span class="line">					center_j = self.center[label_c]</span><br><span class="line">					j2label_c[j] = label_c</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">						predict = eucli_tensor(data,center_j)</span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						predict = torch.cat((predict, eucli_tensor(data,center_j)), <span class="number">0</span>)</span><br><span class="line">					j += <span class="number">1</span></span><br><span class="line">				y_pre_j = <span class="built_in">int</span>(torch.argmax(F.log_softmax(predict)))	<span class="comment">#离第j个中心最近</span></span><br><span class="line">				y_pre = j2label_c[y_pre_j]	<span class="comment">#第j个中心对应得标签是y_pre</span></span><br><span class="line">				test_accury.append(<span class="number">1</span> <span class="keyword">if</span> y_pre == y <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">sum</span>(train_accury)/<span class="built_in">len</span>(train_accury),<span class="built_in">sum</span>(test_accury)/<span class="built_in">len</span>(test_accury)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">save_center</span>(<span class="params">self,path</span>):</span><br><span class="line">		datas = []</span><br><span class="line">		<span class="keyword">for</span> label <span class="keyword">in</span> self.center.keys():</span><br><span class="line">			datas.append([label] + <span class="built_in">list</span>(self.center[label].detach().numpy()))</span><br><span class="line">		<span class="keyword">with</span> <span class="built_in">open</span>(path,<span class="string">"w"</span>, newline=<span class="string">""</span>) <span class="keyword">as</span> datacsv:</span><br><span class="line">			csvwriter = csv.writer(datacsv,dialect = (<span class="string">"excel"</span>))</span><br><span class="line">			csvwriter.writerows(datas)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">load_center</span>(<span class="params">self,path</span>):</span><br><span class="line">		csvReader = csv.reader(<span class="built_in">open</span>(path))</span><br><span class="line">		<span class="keyword">for</span> line <span class="keyword">in</span> csvReader:</span><br><span class="line">			label = <span class="built_in">int</span>(line[<span class="number">0</span>])</span><br><span class="line">			center = [ <span class="built_in">float</span>(line[i]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(line))]</span><br><span class="line">			center = np.array(center)</span><br><span class="line">			center = Variable(torch.from_numpy(center))</span><br><span class="line">			self.center[label] = center</span><br></pre></td></tr></table></figure>
<p>3.define a function <code>load_data</code> to load the omniglot data</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> matplotlib.image <span class="keyword">as</span> mpimg</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="comment">#将图片数据转化为numpy，每一个类得数据被为训练集和测试集，并存储在字典中</span></span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">'D:/prototypical_network/scripts'</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_data</span>():</span><br><span class="line">	labels_trainData = {}</span><br><span class="line">	label = <span class="number">0</span></span><br><span class="line">	labels_testData = {}</span><br><span class="line">	test_number = <span class="number">4</span></span><br><span class="line">	<span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(<span class="string">'D:/prototypical_network/data/images_background'</span>):</span><br><span class="line">		<span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> os.listdir(<span class="string">'D:/prototypical_network/data/images_background/'</span> + file):</span><br><span class="line">			labels_trainData[label] = []</span><br><span class="line">			labels_testData[label] = []</span><br><span class="line">			data = []</span><br><span class="line">			<span class="keyword">for</span> png <span class="keyword">in</span> os.listdir(<span class="string">'D:/prototypical_network/data/images_background/'</span> + file +<span class="string">'/'</span> + <span class="built_in">dir</span>):</span><br><span class="line">				image_np = mpimg.imread(<span class="string">'D:/prototypical_network/data/images_background/'</span> + file +<span class="string">'/'</span> + <span class="built_in">dir</span>+<span class="string">'/'</span> +png)</span><br><span class="line">				image_np.astype(np.float64)</span><br><span class="line">				data.append(image_np)</span><br><span class="line">			labels_trainData[label] = np.array(data[test_number:])</span><br><span class="line">			labels_testData[label] = np.array(data[:test_number])</span><br><span class="line">			label += <span class="number">1</span></span><br><span class="line">	<span class="keyword">return</span> labels_trainData ,labels_testData</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4.train the prototypical network</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">'D:/prototypical_network/protonets'</span>)</span><br><span class="line"><span class="keyword">from</span> protonets.protonets_net <span class="keyword">import</span> Protonets</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line">os.chdir(<span class="string">'D:/prototypical_network/scripts'</span>)</span><br><span class="line"><span class="keyword">import</span> load_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="comment">##载入数据</span></span><br><span class="line">	labels_trainData ,labels_testData = load_data.load_data()</span><br><span class="line">	class_number = <span class="built_in">max</span>(<span class="built_in">list</span>(labels_trainData.keys()))</span><br><span class="line">	</span><br><span class="line">	wide = labels_trainData[<span class="number">0</span>][<span class="number">0</span>].shape[<span class="number">0</span>]</span><br><span class="line">	length = labels_trainData[<span class="number">0</span>][<span class="number">0</span>].shape[<span class="number">1</span>]</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> label <span class="keyword">in</span> labels_trainData.keys():</span><br><span class="line">		labels_trainData[label] = np.reshape(labels_trainData[label], [-<span class="number">1</span>,<span class="number">1</span>,wide, length])</span><br><span class="line">		labels_testData[label] = np.reshape(labels_testData[label], [-<span class="number">1</span>,<span class="number">1</span>,wide, length])</span><br><span class="line">	</span><br><span class="line">	<span class="comment">##初始化模型</span></span><br><span class="line">	protonets = Protonets((<span class="number">1</span>,wide,length),<span class="number">10</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">60</span>,<span class="string">'D:/prototypical_network/log/'</span>,<span class="number">50</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">##训练prototypical_network</span></span><br><span class="line">	<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">		<span class="comment">##随机选取x个类进行一个episode的训练</span></span><br><span class="line">		protonets.train(labels_trainData,class_number)</span><br><span class="line">		<span class="built_in">print</span>(n)</span><br><span class="line">		<span class="keyword">if</span> n % <span class="number">1</span> == <span class="number">0</span> <span class="keyword">and</span> n != <span class="number">0</span>:	<span class="comment">#每50次存储一次模型，并测试模型的准确率，训练集的准确率和测试集的准确率被存储在model_step_eval.txt中</span></span><br><span class="line">			torch.save(protonets.model, <span class="string">'D:/prototypical_network/log/model_net_'</span>+<span class="built_in">str</span>(n)+<span class="string">'.pkl'</span>)</span><br><span class="line">			protonets.save_center(<span class="string">'D:/prototypical_network/log/model_center_'</span>+<span class="built_in">str</span>(n)+<span class="string">'.csv'</span>)</span><br><span class="line">			train_accury,test_accury = protonets.evaluation_model(labels_testData,labels_trainData)</span><br><span class="line">			<span class="built_in">print</span>(train_accury,test_accury)</span><br><span class="line">			str_data = <span class="built_in">str</span>(n) + <span class="string">','</span> + <span class="built_in">str</span>(train_accury) + <span class="string">'\n'</span></span><br><span class="line">			<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'D:/prototypical_network/log/model_step_eval.txt'</span>, <span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">				f.write(str_data)</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>jimore
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2022/09/11/Prototypical-Networks-for-Few-shot-Learning/" title="Prototypical Networks for Few-shot Learning">http://example.com/2022/09/11/Prototypical-Networks-for-Few-shot-Learning/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="fa fa-tag"></i></a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/09/11/%E5%AF%B9%E8%AE%AD%E7%BB%83%E5%90%8E%E6%95%B0%E6%8D%AE%E9%9B%86%E7%94%BB%E6%95%A3%E7%82%B9%E5%9B%BE%E8%A7%82%E5%AF%9F%E5%88%86%E7%B1%BB%E6%95%88%E6%9E%9C/" rel="prev" title="对训练后数据集画散点图观察分类效果">
      <i class="fa fa-chevron-left"></i> 对训练后数据集画散点图观察分类效果
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/15/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8E%9F%E7%90%86%E8%AF%BE%E5%90%8E%E4%B9%A0%E9%A2%98/" rel="next" title="数据库原理课后习题">
      数据库原理课后习题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  
 
   <div>
     <div>
    
        <div style="text-align:center;color: #ccc;font-size:24px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
   </div>
 



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">Prototypical Networks for Few-shot Learning</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Introduction-of-Prototypical-Networks"><span class="nav-number">1.1.</span> <span class="nav-text">1. Introduction of Prototypical Networks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-The-working-function-of-Prototypical-Networks"><span class="nav-number">1.2.</span> <span class="nav-text">2.The working function of Prototypical Networks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1Example"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1Example</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-The-description-of-the-algorithm"><span class="nav-number">1.3.</span> <span class="nav-text">3.The description of the algorithm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Implementation-of-Prototypical-Networks"><span class="nav-number">1.4.</span> <span class="nav-text">4. Implementation of Prototypical Networks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Prototypical-Networks-implementation-in-Omniglot"><span class="nav-number">1.5.</span> <span class="nav-text">5.Prototypical Networks implementation in Omniglot</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jimore"
      src="/images/hh.jpg">
  <p class="site-author-name" itemprop="name">jimore</p>
  <div class="site-description" itemprop="description">Don't let the dream just be the dream</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jimore</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共30.4k字</span>
</div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共30.4k字</span>
  <span class="post-meta-divider">|</span>
  本站总访问量<span id="busuanzi_value_site_pv"></span>次
  <span class="post-meta-divider">|</span>
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
  <span class="post-meta-divider">|</span>
  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
</div>


        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>


  <script defer src="/lib/three/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

